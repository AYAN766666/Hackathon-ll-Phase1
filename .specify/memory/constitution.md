<!--
Sync Impact Report:
- Version change: 2.0.0 â†’ 3.0.0 (major update from Phase II to Phase III)
- Modified principles: Purpose-Driven Development, Scope Adherence, Development Rule Compliance, Functional Completeness
- Added sections: AI Agent Constitution, MCP Server Constitution, AI Agent Integration Rules, Authentication & Security for AI
- Removed sections: None
- Templates requiring updates: âš  pending - .specify/templates/plan-template.md, .specify/templates/spec-template.md, .specify/templates/tasks-template.md
- Follow-up TODOs: None
-->
# AI Agent + MCP Server Integrated Todo Application Constitution - Phase III

## Core Principles

### Purpose-Driven Development
The purpose of this project is to demonstrate Spec-Driven Development using Claude Code and Spec-Kit Plus. Phase III focuses on integrating an AI Agent and MCP Server into the existing Phase II full-stack web application. This phase validates the developer's ability to implement AI-powered natural language interfaces while maintaining the integrity of existing functionality and establishing secure API bridges between AI agents and backend services.

### Scope Adherence
This constitution applies strictly to Phase III of the hackathon. Included: AI Agent implementation using OpenAI Agents SDK, MCP Server as a bridge between AI agent and FastAPI backend, SQLite database for AI agent operations, Gemini AI integration, JWT authentication enforcement for AI requests, task management via natural language commands, AI agent UI integration in dashboard. Excluded: Deleting or modifying any Phase II functionality, direct database access by AI agent, general chat capabilities, bypassing existing APIs.

### Development Rule Compliance (NON-NEGOTIABLE)
All code MUST be generated by Claude Code. Manual coding is strictly prohibited. All functionality MUST be defined in specifications before implementation. Specs are the single source of truth. UV MUST be used for Python project and dependency management. Python version MUST be 3.13 or higher. OpenAI Agents SDK MUST be used for AI agent implementation. MCP Server MUST act as the sole bridge between AI agent and backend. SQLite MUST be used as file-based database for AI operations. Gemini AI MUST be configured using OpenAI-compatible API. Phase II code MUST NOT be deleted or modified. Violating any rule invalidates the phase submission.

### Functional Completeness
The application MUST support the following features: AI Agent Message Processing (natural language understanding), AI Decision Making (determining appropriate Todo actions), MCP Server Tool Calls (create_task, list_tasks, update_task, delete_task, complete_task), JWT Token Verification (for all AI requests), User Data Isolation (AI operations respect user boundaries), Natural Language Task Commands (add, delete, view, edit, complete tasks via chat), AI Agent UI Integration (accessible from dashboard after login), SQLite Persistence (for AI agent operations). All operations MUST respect user data isolation.

### Data Model Consistency
The application MUST maintain database integrity with the following structure:
- User Table (existing from Phase II): id (Integer PK), email (String unique), hashed_password (String), created_at (DateTime)
- Task Table (existing from Phase II): id (Integer PK), title (String), description (String), completed (Boolean), user_id (Foreign Key to User.id)
- AI Agent SQLite Tables: conversation history, agent state, and operational data stored in file-based SQLite database
All data MUST be stored persistently with proper relationships maintained between user accounts and their tasks.

## AI Agent Constitution

### AI Agent Technology Stack
- Python MUST be used for AI agent implementation
- OpenAI Agents SDK MUST be used for agent functionality
- Gemini AI (gemini-2.0-flash) MUST be configured as the LLM
- SQLite MUST be used as file-based database for agent operations
- UV package manager MUST be used for dependencies

### AI Agent Capabilities
- Task addition via natural language commands
- Task deletion via natural language commands
- Task viewing/listing via natural language commands
- Task editing/updating via natural language commands
- Task completion toggling via natural language commands
- Off-topic request rejection with clear messaging
- JWT-authenticated user context awareness

### AI Agent Limitations (STRICT RULES)
- AI agent MUST NOT engage in general chat conversations
- AI agent MUST NOT respond to off-topic requests
- AI agent MUST NOT access database directly
- AI agent MUST NOT bypass existing FastAPI APIs
- AI agent MUST NOT modify or corrupt Phase II data
- AI agent MUST ONLY perform Todo-related actions

### AI Agent Configuration
The AI agent MUST be configured with the following settings:
```python
async def main():
    api_key = os.getenv("GEMINI_API_KEY")

    external_client = AsyncOpenAI(
        api_key=api_key,
        base_url="https://generativelanguage.googleapis.com/v1beta/openai/"
    )

    model = OpenAIChatCompletionsModel(
        model = "gemini-2.0-flash",
        openai_client=external_client
    )

    run_config = RunConfig(
         model=model,
         model_provider=external_client,
         tracing_disabled=True
    )
```

## MCP Server Constitution

### MCP Server Role
- MCP Server MUST act as the bridge between AI agent and FastAPI backend
- MCP Server MUST convert Todo APIs into MCP tools
- MCP Server MUST verify JWT tokens for all requests
- MCP Server MUST extract and enforce user_id boundaries
- MCP Server MUST maintain security and operational boundaries

### MCP Tools Specification
- create_task: Maps to POST /api/{user_id}/tasks
- list_tasks: Maps to GET /api/{user_id}/tasks
- update_task: Maps to PUT /api/{user_id}/tasks/{id}
- delete_task: Maps to DELETE /api/{user_id}/tasks/{id}
- complete_task: Maps to PATCH /api/{user_id}/tasks/{id}/complete

### MCP Server Enforcement
- MCP Server MUST NOT operate without valid JWT token
- MCP Server MUST NOT allow direct database access
- MCP Server MUST NOT bypass existing API validation
- MCP Server MUST enforce strict user_id boundaries
- MCP Server MUST return appropriate error responses

## AI Agent Integration Rules

### Backend Integration
- AI agent MUST run within the existing FastAPI backend
- AI agent MUST use existing APIs exclusively (no direct DB access)
- AI agent MUST respect all existing authentication mechanisms
- AI agent MUST maintain Phase II functionality intact
- Database access MUST be through existing FastAPI API layer only

### Frontend Integration
- AI Agent UI MUST be accessible from dashboard after login
- AI Agent icon MUST be blue (ðŸ”µ) and clearly visible
- Chat panel MUST open when icon is clicked
- UI background MUST be white (âšª) with blue header
- Error messages MUST use red (ðŸ”´) for warnings/deletions
- UI MUST match Phase II color theme consistency

### User Interface Requirements

### Frontend Technology
- Next.js App Router MUST be used for routing
- Clean, responsive UI with consistent styling
- Proper form validation and error handling
- JWT token management in browser storage
- API calls MUST include authentication tokens

### Page Structure
- `/login` - Login page with email/password form and signup link
- `/signup` - Signup page with email/password form and login link
- `/dashboard` - Dashboard showing welcome message, create task button, task list, and AI agent icon
- `/tasks` - Tasks page showing all user tasks with CRUD operations

### UI Design Requirements
- Background color: #f9fafb
- Primary button color: #2563eb
- Text color: #111827
- Success color: #16a34a
- Error color: #dc2626
- AI Agent icon color: #2563eb (blue)
- AI Agent background: #ffffff (white)
- All UI elements MUST be clearly visible and accessible
- All buttons MUST have clear labels and appropriate functionality

### Login Page (`/login`)
- Centered form box with email input, password input, and login button
- Link to signup page: "Don't have an account? Sign up"
- After successful login, user MUST be redirected to dashboard

### Signup Page (`/signup`)
- Simple form with email and password inputs
- Validation errors MUST be displayed
- After successful signup, user MUST be redirected to login page

### Dashboard (`/dashboard`)
- Welcome message showing user's email: "Welcome, {user_email} ðŸ‘‹"
- "Create New Task" button
- List of user's tasks with edit/delete/complete options
- Top navigation bar with app name and logout button
- AI Agent icon (ðŸ”µ Blue) accessible for logged-in users
- Clicking AI icon opens AI chat panel

### Tasks Page (`/tasks`)
- Each task MUST display: title (bold), description (small text), status (completed/pending)
- Each task MUST have: Edit, Delete, Complete/Incomplete buttons
- User MUST be able to create, read, update, delete, and toggle completion of tasks

## Authentication & Security for AI

### JWT Token Requirements
- JWT tokens MUST be required for all AI agent requests
- MCP Server MUST validate JWT tokens for every tool call
- User identity MUST be extracted from validated tokens
- Invalid tokens MUST result in request rejection
- Token expiration MUST be respected by AI system

### User Data Isolation
- AI agent MUST ONLY access logged-in user's tasks
- MCP Server MUST enforce user_id boundaries strictly
- Cross-user data access MUST be prevented completely
- User context MUST be maintained throughout AI interactions
- Authentication MUST be verified for each AI operation

### Security Constraints
- Passwords MUST never be stored in plain text
- Passwords MUST be hashed using proper hashing algorithms
- JWT tokens MUST have appropriate expiration times
- User data MUST be completely isolated (one user cannot access another's data)
- Authentication MUST be required for all AI operations
- Database queries MUST use parameterized statements to prevent injection
- AI agent MUST NOT store sensitive user data unnecessarily

## Quality Standards
Code MUST be readable and maintainable. Functions MUST be small and focused. No unused code. No commented-out code. All tests MUST pass before deployment. Error handling MUST be comprehensive and user-friendly. AI responses MUST be relevant and task-focused. MCP Server calls MUST be secure and validated.

## Verification Criteria
Phase III is considered complete when: The AI agent responds to natural language Todo commands, MCP Server successfully bridges AI requests to backend APIs, JWT authentication works for all AI interactions, SQLite database properly handles AI agent operations, Gemini AI is properly configured and responding, The existing Phase II functionality remains unchanged and operational, AI agent respects user data boundaries, AI agent rejects off-topic requests appropriately, The repository contains full spec history, No manual code changes are present, UI integrates AI agent according to specified design requirements.

## Governance
This constitution applies to Phase III. Phase I and II code remains unchanged. All development must strictly adhere to the rules defined in this constitution. Any deviation invalidates the phase submission. Amendments to this constitution require explicit approval and version increment.

**Version**: 3.0.0 | **Ratified**: 2025-12-30 | **Last Amended**: 2026-01-12